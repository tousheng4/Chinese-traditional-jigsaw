# 自制拼图功能需求分析文档（PRD）

## 0. 文档信息
- 功能名称：自制拼图（UGC Puzzle）
- 目标平台：iOS / iPadOS
- 技术栈：SwiftUI（PhotosUI / UIKit bridging 视需要）
- 数据策略：默认本地离线；后续可扩展云同步
- 术语：
  - UGC：用户自定义内容（主要指用户导入的图片与其派生的拼图关卡）
  - 关卡：可被游玩的一个拼图实例（含图片、难度、规则配置与进度记录）

---

## 1. 背景与目标

### 1.1 背景
传统文化拼图以策展内容为主，但用户对“把自己的照片国风化、仪式化并可玩”的需求天然存在。自制拼图既是可持续内容供给，也是分享传播的起点：玩家完成的并非一张图，而是一段可被保存与赠予的“复原叙事”。

### 1.2 产品目标（可量化）
- 让用户在 **≤ 60 秒** 内完成一次“导入图片 → 生成关卡 → 开始游玩”的闭环（MVP）。
- 保证导入图片在不同设备上 **不崩溃、不糊、不超内存**（性能与稳定性目标）。
- 自制关卡具备“国风呈现”能力：纸张肌理、边框、题跋/印章（可选）等装饰层（MVP可先做轻量模板）。

### 1.3 非目标（MVP 不做）
- 不做在线发布/社区（避免内容审核与合规成本在早期放大）。
- 不做跨设备同步（可作为后续版本）。
- 不做复杂 AI 生成（可预留接口但不作为交付条件）。

---

## 2. 用户画像与核心场景

### 2.1 用户画像
- 休闲玩家：想把家人/宠物/旅行照做成“可玩的小纪念”
- 传统文化爱好者：希望用宣纸、印章、题跋框住私人图像，使其“入画”
- 分享型玩家：需要可一键分享的完成卡片与纪念图

### 2.2 核心场景
1) 用户从相册选一张照片，裁切为合适构图，选择难度，生成关卡并开始拼图。  
2) 用户完成拼图后生成“明信片式成品图”（含边框、题跋风格、印章签名），分享给朋友。  
3) 用户管理“我的拼图”：查看、重复游玩、删除、导出分享。

---

## 3. 范围与优先级

### 3.1 MVP（P0 必须）
- 导入图片（相册选择）
- 编辑裁切（确定拼图区域）
- 选择难度（网格块数）
- 生成并保存自制关卡
- 自制关卡列表与进入游玩
- 本地持久化（关卡元数据 + 缩略图 + 预处理后的主图）
- 删除自制关卡（含派生资源清理）
- 完成后分享成品卡片（系统分享面板）

### 3.2 增强（P1 推荐）
- 相机拍摄导入
- “国风模板”系统（纸纹、边框、印章、题跋占位）
- 自制关卡标签/收藏
- 难度更细：允许旋转拼图块、打乱模式选择
- 存储空间管理入口（显示占用与一键清理缓存）

### 3.3 远期（P2 可选）
- iCloud 同步
- 自制拼图导出/导入（关卡包）
- 在线分享/挑战（同种子打乱竞速）
- 更高级“国风化”滤镜或生成式增强

---

## 4. 功能需求详述

### 4.1 自制流程（Creation Wizard）
建议采用分步式流程（Stepper/多页导航）：
1) 选择图片 → 2) 编辑裁切 → 3) 配置玩法 → 4) 预览与保存 → 5) 开始游玩

#### 4.1.1 选择图片（P0）
- 数据源：
  - 相册（PhotosUI `PhotosPicker`）
- 权限：
  - 使用系统选取器优先（降低权限负担；用户选择即授权读所选资源）
- 支持格式：
  - HEIC / JPEG / PNG（由系统解码）
- 失败处理：
  - 选取失败、图片不可读、解码失败时提示并允许重试

#### 4.1.2 编辑裁切（P0）
- 目标：确定拼图使用的“可玩区域”
- 功能：
  - 缩放、拖动构图
  - 旋转（可选；MVP 可不支持自由旋转，仅支持 90°）
  - 裁切比例：
    - 默认“自适应屏幕”或“固定比例”（建议提供：1:1、4:3、3:4、16:9）
  - 预览叠加：显示裁切框与安全区域
- 质量策略：
  - 裁切结果生成一张“预处理主图”（见 6.2），避免直接使用原图导致内存风险

#### 4.1.3 配置玩法（P0）
- 难度（网格块数）：
  - 简单：3×3
  - 标准：4×4
  - 困难：6×6
- 规则开关（P1）：
  - 拼图块可旋转（默认关）
  - 吸附强度（强/中/弱）
  - 打乱模式（散布/堆叠）

#### 4.1.4 国风模板（P1）
- 模板定义：对主图叠加装饰层（不改动用户原图语义，尽量“装裱式”）
- 组件：
  - 纸张肌理（宣纸、绢本等）
  - 边框（卷轴、册页、画框）
  - 印章（可选：固定印章或用户自定义“印文文本”生成简易图章）
  - 题签/题跋区（可选：标题、日期、署名）
- 注意：
  - 玩法层仍以“主图区域”切块；装饰层可作为背景或完成后展示层

#### 4.1.5 预览与保存（P0）
- 保存内容：
  - 关卡缩略图（用于列表）
  - 预处理主图（用于切块渲染）
  - 关卡元数据（名称、创建时间、配置）
- 命名策略：
  - 默认名：`我的拼图 2025-12-15 21:30`
  - 支持用户编辑标题（P1）

#### 4.1.6 开始游玩（P0）
- 保存成功后提供按钮：
  - “立即开始”
  - “返回我的拼图”

---

### 4.2 我的拼图（UGC Library）
#### 4.2.1 列表页（P0）
- 展示字段：
  - 缩略图、标题、难度、完成状态、最佳记录（若存在）
- 支持操作：
  - 点击进入详情/继续游戏
  - 左滑删除（需二次确认）
- 排序（P1）：
  - 最近创建、最近游玩、已完成优先

#### 4.2.2 详情页（P1）
- 展示：
  - 预览图、配置（块数、规则）、统计（完成次数、最佳时间/步数）
- 操作：
  - 开始/继续
  - 重置进度（确认）
  - 编辑（更换标题/模板；更换难度可视为“新关卡”或“同关卡新配置”，需在 5.3 定义）

---

### 4.3 分享与导出
#### 4.3.1 完成卡片分享（P0）
- 生成内容：
  - 成品图（可带国风边框/题跋/印章）
  - 统计信息：用时、步数、难度（可开关）
- 技术：
  - 使用 `UIActivityViewController`（SwiftUI 包装）
- 隐私：
  - 默认不嵌入地理位置等 EXIF；导出图片建议去除敏感元数据（见 7.2）

#### 4.3.2 导出关卡包（P2）
- 将关卡元数据 + 主图资源打包（zip/自定义扩展名），便于在设备间迁移
- 需要额外安全校验与版本兼容策略

---

## 5. 规则、口径与边界约定

### 5.1 自制关卡是否计入成就
建议默认：
- 不计入“传统模块成就”（年画/脸谱/敦煌/国画）
- 可另设“自制成就”：
  - 创建 N 个自制关卡
  - 完成 N 个自制关卡
  - 分享 N 次完成卡片

### 5.2 “同一图片不同难度”的身份策略（重要）
给出两种可选口径（二选一写死，避免数据混乱）：
- 策略 A（推荐，清晰）：难度不同视为不同关卡  
  - 同一图片可以创建多个关卡实体（不同 `levelId`）
- 策略 B（偏管理型）：同一关卡可切换难度  
  - 关卡实体固定，但每个难度有独立进度记录（复杂度更高）

MVP 建议采用策略 A。

### 5.3 删除策略
- 删除自制关卡 = 删除关卡元数据 + 进度 + 主图资源 + 缩略图（强一致性清理）
- 若资源正在被系统分享/读取，需做引用保护或延迟删除队列（实现上可先“标记删除”，后台清理）

---

## 6. 数据与技术设计约束（面向 SwiftUI 落地）

### 6.1 数据模型（概念）
- `UGCPuzzle`
  - `id: UUID`
  - `title: String`
  - `createdAt: Date`
  - `updatedAt: Date`
  - `imageAssetPath: String`（预处理主图存储路径）
  - `thumbnailPath: String`
  - `category: .ugc`
  - `config: PuzzleConfig`
  - `style: UGCStyleConfig`（模板信息，P1）
- `PuzzleConfig`
  - `grid: (rows, cols)`
  - `allowRotation: Bool`
  - `shuffleMode: Enum`
  - `snapStrength: Enum`
- `UGCProgress`
  - `puzzleId: UUID`
  - `isCompleted: Bool`
  - `bestTime: TimeInterval?`
  - `bestMoves: Int?`
  - `lastPlayedAt: Date?`

### 6.2 图像预处理与性能策略（必须明确）
- 原则：不要在拼图引擎直接使用原始超大图（避免内存峰值与卡顿）
- 建议流程：
  1) 选取后读取原图
  2) 按目标最大边长缩放（例如 2048 或随设备档位调整）
  3) 应用裁切，得到“预处理主图”
  4) 生成缩略图（如 512 边）
  5) 将预处理图写入 App 沙盒（Documents/Application Support）
- 切块渲染策略：
  - **存 rect，不存每块位图**：拼图块通过 `cropRect` 在绘制时从主图裁切渲染（必要时做缓存）
  - 仅在拖拽中的块提高分辨率或缓存优先级

### 6.3 存储与容量
- 需要一个“容量上限”策略（P1）：
  - 默认允许创建 N 个（如 50）或总容量上限（如 500MB）
  - 超限时提示用户清理或自动降质缩略图/缓存
- 提供“清理缓存”入口（P1）

---

## 7. 安全、隐私与合规

### 7.1 权限与最小化
- 优先使用 `PhotosPicker`（用户选择即授权，无需全库权限）
- 相机导入（P1）需申请相机权限；失败时提供替代路径（相册导入）

### 7.2 敏感元数据处理
- 分享导出图片时建议移除 EXIF 中可能包含的定位信息与拍摄设备信息（实现可在导出时重编码图片数据）

### 7.3 内容治理（离线前提下）
- 若不做在线发布，内容审核需求显著降低
- 仍需防止“应用内展示崩坏”：
  - 限制图片尺寸、格式
  - 对异常图片进行降级处理与错误提示

---

## 8. 交互与界面需求（UI/UX）

### 8.1 入口布局
- 在主页或关卡页增加入口：
  - “自制拼图”
- 自制拼图页包含：
  - “新建拼图”按钮（突出）
  - “我的拼图”列表

### 8.2 状态反馈
- 预处理阶段显示进度与可取消（避免大图处理导致用户误以为卡死）
- 保存成功提供即时回馈：轻提示 + 可选分享/立即开始

### 8.3 无障碍（P0）
- 选择器、按钮、列表项具备可读 label
- 动效遵从“减少动态效果”系统设置
- 文本对比度与字体缩放适配

---

## 9. 异常与边界场景清单（必须覆盖）
- 用户拒绝相册权限/选择器不可用
- 图片过小（放大后糊到不可玩）：提示并建议换图
- 超大图导致处理时间长：必须有进度提示与取消
- 导入 Live Photo / 动图：需明确只取静帧
- 横竖屏切换导致裁切框错位：裁切参数使用归一化坐标（0~1）保存
- 低存储空间写入失败：提示并引导清理
- 删除正在游玩的关卡：阻止或提示“退出后删除”

---

## 10. 验收标准（DoD）

### 10.1 功能验收（P0）
- 能从相册创建自制关卡并成功进入游玩
- 关卡在“我的拼图”列表可见，重启应用后仍存在
- 删除关卡后列表消失，存储资源被清理（可通过占用变化或文件不存在验证）
- 完成关卡后可生成并打开系统分享面板

### 10.2 性能验收（P0）
- 导入 12MP 照片不崩溃
- 拼图拖拽无明显掉帧（以主流设备为准）
- 生成与保存过程不出现 UI 假死（有进度或 loading）

---

## 11. 数据埋点建议（可选但利于迭代）
- 进入自制入口次数
- 创建流程漏斗：选择图 → 裁切 → 配置 → 保存 → 开始
- 平均创建耗时、失败原因分布（解码失败、写入失败、取消等）
- 分享触发率与分享后回流率

---

## 12. 风险与对策
- 风险：UGC 图片分辨率与比例差异极大，导致体验不稳定  
  - 对策：强制预处理缩放、归一化裁切参数、限制最大像素
- 风险：存储膨胀  
  - 对策：容量上限 + 清理入口 + 不存每块位图
- 风险：隐私争议（照片权限/元数据）  
  - 对策：系统选取器最小授权；导出重编码去除敏感元数据

---

## 13. 里程碑建议（实现顺序）
1) P0：相册导入 + 裁切 + 生成关卡 + 列表管理 + 游玩入口 + 分享完成卡片  
2) P1：国风模板 + 相机导入 + 容量管理 + 更细规则开关  
3) P2：云同步/导出包/挑战玩法
